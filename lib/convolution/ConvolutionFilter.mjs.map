{"version":3,"file":"ConvolutionFilter.mjs","sources":["../../src/convolution/ConvolutionFilter.ts"],"sourcesContent":["import { deprecation, Filter, GlProgram, GpuProgram, PointData } from 'pixi.js';\r\nimport { vertex, wgslVertex } from '../defaults';\r\nimport fragment from './convolution.frag';\r\nimport source from './convolution.wgsl';\r\n\r\ntype FixedArray<T, L extends number> = [ T, ...Array<T> ] & { length: L };\r\n\r\nexport type ConvolutionMatrix = Float32Array | FixedArray<number, 9>;\r\n\r\n/** Options for the ConvolutionFilter constructor. */\r\nexport interface ConvolutionFilterOptions\r\n{\r\n    /**\r\n     * An array of values used for matrix transformation, specified as a 9 point Array\r\n     * @example\r\n     * const matrix = new Float32Array(9); // 9 elements of value 0\r\n     * const matrix = [0,0.5,0,0.5,1,0.5,0,0.5,0];\r\n     * @default [0,0,0,0,0,0,0,0,0]\r\n     */\r\n    matrix?: ConvolutionMatrix;\r\n    /**\r\n     * Width of the object you are transforming\r\n     * @default 200\r\n     */\r\n    width?: number;\r\n    /**\r\n     * Height of the object you are transforming\r\n     * @default 200\r\n     */\r\n    height?: number;\r\n}\r\n\r\n/**\r\n * The ConvolutionFilter class applies a matrix convolution filter effect.\r\n * A convolution combines pixels in the input image with neighboring pixels to produce a new image.\r\n * A wide variety of image effects can be achieved through convolutions, including blurring, edge\r\n * detection, sharpening, embossing, and beveling. The matrix should be specified as a 9 point Array.\r\n * See https://docs.gimp.org/2.10/en/gimp-filter-convolution-matrix.html for more info.<br>\r\n * ![original](../screenshots/original.png)![filter](../screenshots/convolution.png)\r\n *\r\n * @class\r\n * @extends Filter\r\n */\r\nexport class ConvolutionFilter extends Filter\r\n{\r\n    /** Default values for options. */\r\n    public static readonly DEFAULT_OPTIONS: ConvolutionFilterOptions = {\r\n        matrix: new Float32Array(9),\r\n        width: 200,\r\n        height: 200,\r\n    };\r\n\r\n    public uniforms: {\r\n        uMatrix: ConvolutionMatrix;\r\n        uTexelSize: PointData;\r\n    };\r\n\r\n    /**\r\n     * @param options - Options for the ConvolutionFilter constructor.\r\n     */\r\n    constructor(options?: ConvolutionFilterOptions);\r\n    /**\r\n     * @deprecated since 6.0.0\r\n     *\r\n     * @param {number[]} [matrix=[0,0,0,0,0,0,0,0,0]] - An array of values used for matrix transformation.\r\n     *        Specified as a 9 point Array.\r\n     * @param {number} [width=200] - Width of the object you are transforming\r\n     * @param {number} [height=200] - Height of the object you are transforming\r\n     */\r\n    constructor(matrix: number[], width?: number, height?: number);\r\n    /** @ignore */\r\n    constructor(...args: [ConvolutionFilterOptions?] | [number[], number?, number?])\r\n    {\r\n        let options = args[0] ?? {};\r\n\r\n        if (Array.isArray(options))\r\n        {\r\n            // eslint-disable-next-line max-len\r\n            deprecation('6.0.0', 'ConvolutionFilter constructor params are now options object. See params: { matrix, width, height }');\r\n\r\n            options = { matrix: options as ConvolutionMatrix };\r\n\r\n            if (args[1] !== undefined) options.width = args[1];\r\n            if (args[2] !== undefined) options.height = args[2];\r\n        }\r\n\r\n        options = { ...ConvolutionFilter.DEFAULT_OPTIONS, ...options };\r\n\r\n        const width = options.width ?? 200;\r\n        const height = options.height ?? 200;\r\n\r\n        const gpuProgram = GpuProgram.from({\r\n            vertex: {\r\n                source: wgslVertex,\r\n                entryPoint: 'mainVertex',\r\n            },\r\n            fragment: {\r\n                source,\r\n                entryPoint: 'mainFragment',\r\n            },\r\n        });\r\n\r\n        const glProgram = GlProgram.from({\r\n            vertex,\r\n            fragment,\r\n            name: 'convolution-filter',\r\n        });\r\n\r\n        super({\r\n            gpuProgram,\r\n            glProgram,\r\n            resources: {\r\n                convolutionUniforms: {\r\n                    uMatrix: { value: options.matrix, type: 'mat3x3<f32>' },\r\n                    uTexelSize: { value: { x: 1 / width, y: 1 / height }, type: 'vec2<f32>' },\r\n                },\r\n            },\r\n        });\r\n\r\n        this.uniforms = this.resources.convolutionUniforms.uniforms;\r\n\r\n        this.width = width;\r\n        this.height = height;\r\n    }\r\n\r\n    /**\r\n     * An array of values used for matrix transformation, specified as a 9 point Array\r\n     * @example\r\n     * const matrix = new Float32Array(9); // 9 elements of value 0\r\n     * const matrix = [0,0.5,0,0.5,1,0.5,0,0.5,0];\r\n     * @default [0,0,0,0,0,0,0,0,0]\r\n     */\r\n    get matrix(): ConvolutionMatrix { return this.uniforms.uMatrix; }\r\n    set matrix(matrix: ConvolutionMatrix)\r\n    {\r\n        matrix.forEach((v, i) =>\r\n        {\r\n            this.uniforms.uMatrix[i] = v;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Width of the object you are transforming\r\n     * @default 200\r\n     */\r\n    get width(): number { return 1 / this.uniforms.uTexelSize.x; }\r\n    set width(value: number) { this.uniforms.uTexelSize.x = 1 / value; }\r\n\r\n    /**\r\n     * Height of the object you are transforming\r\n     * @default 200\r\n     */\r\n    get height(): number { return 1 / this.uniforms.uTexelSize.y; }\r\n    set height(value: number) { this.uniforms.uTexelSize.y = 1 / value; }\r\n}\r\n"],"names":[],"mappings":"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"}