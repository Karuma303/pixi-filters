{"version":3,"file":"ColorGradientFilter.mjs","sources":["../../src/color-gradient/ColorGradientFilter.ts"],"sourcesContent":["import { Color, ColorSource, Filter, GlProgram, GpuProgram } from 'pixi.js';\r\nimport fragment from './color-gradient.frag';\r\nimport vertex from './color-gradient.vert';\r\nimport source from './color-gradient.wgsl';\r\nimport { parseCssGradient } from './CssGradientParser';\r\n\r\n/** Color stop object. */\r\nexport interface ColorStop\r\n{\r\n    offset: number;\r\n    color: ColorSource;\r\n    alpha: number;\r\n}\r\n\r\n/** Options for ColorGradientFilter constructor. */\r\nexport interface ColorGradientFilterOptions\r\n{\r\n    /**\r\n     * Linear = 0, Radial = 1, Conic = 2\r\n     * @default ColorGradientFilter.LINEAR\r\n     */\r\n    type: number;\r\n    /** Collection of stops, must be 2+ */\r\n    stops: ColorStop[];\r\n    /**\r\n     * Angle for linear gradients, in degrees.\r\n     * @default 90\r\n     */\r\n    angle?: number;\r\n    /**\r\n     * Alpha value for the gradient.\r\n     * @default 1\r\n     */\r\n    alpha?: number;\r\n    /**\r\n     * Maximum number of colors to render (0 = no limit)\r\n     * @default 0\r\n     */\r\n    maxColors?: number;\r\n    /**\r\n     * If true, the gradient will replace the existing color, otherwise it will be multiplied with it\r\n     * @default false\r\n     */\r\n    replace?: boolean;\r\n}\r\n\r\n/** Options for CSS-style gradient for use with constructor. */\r\nexport interface ColorGradientFilterCSSOptions\r\n{\r\n    /** CSS-style gradient string */\r\n    css: string;\r\n    /**\r\n     * Alpha value for the gradient.\r\n     * @default 1\r\n     */\r\n    alpha?: number;\r\n    /**\r\n     * Maximum number of colors to render (0 = no limit)\r\n     * @default 0\r\n     */\r\n    maxColors?: number;\r\n}\r\n\r\nconst ANGLE_OFFSET = 90; // align degrees with CSS\r\n\r\nfunction sortColorStops(stops: ColorStop[]): ColorStop[]\r\n{\r\n    return [...stops].sort((a, b) => a.offset - b.offset);\r\n}\r\n\r\n/**\r\n * Render a colored gradient.<br>\r\n * ![original](../screenshots/original.png)![filter](../screenshots/color-gradient.png)\r\n *\r\n * @class\r\n * @extends Filter\r\n */\r\nexport class ColorGradientFilter extends Filter\r\n{\r\n    /** Gradient types */\r\n    static readonly LINEAR = 0;\r\n    static readonly RADIAL = 1;\r\n    static readonly CONIC = 2;\r\n\r\n    /** Default constructor options */\r\n    public static readonly defaults: ColorGradientFilterOptions = {\r\n        type: ColorGradientFilter.LINEAR,\r\n        stops: [\r\n            { offset: 0.0, color: 0xff0000, alpha: 1.0 },\r\n            { offset: 1.0, color: 0x0000ff, alpha: 1.0 },\r\n        ],\r\n        alpha: 1.0,\r\n        angle: 90.0,\r\n        maxColors: 0,\r\n        replace: false,\r\n    };\r\n\r\n    public baseUniforms: {\r\n        uOptions: Float32Array;\r\n        uCounts: Float32Array;\r\n    };\r\n\r\n    public stopsUniforms: {\r\n        uColors: Float32Array;\r\n        uStops: Float32Array;\r\n    };\r\n\r\n    private _stops: ColorStop[] = [];\r\n\r\n    /**\r\n     * @param options - Options for the ColorGradientFilter constructor.\r\n     */\r\n    constructor(options?: ColorGradientFilterOptions | ColorGradientFilterCSSOptions)\r\n    {\r\n        if (options && 'css' in options)\r\n        {\r\n            options = {\r\n                ...parseCssGradient(options.css || ''),\r\n                alpha: options.alpha ?? ColorGradientFilter.defaults.alpha,\r\n                maxColors: options.maxColors ?? ColorGradientFilter.defaults.maxColors,\r\n            };\r\n        }\r\n        else\r\n        {\r\n            options = { ...ColorGradientFilter.defaults, ...options };\r\n        }\r\n\r\n        if (!options.stops || options.stops.length < 2)\r\n        {\r\n            throw new Error('ColorGradientFilter requires at least 2 color stops.');\r\n        }\r\n\r\n        const gpuProgram = GpuProgram.from({\r\n            vertex: {\r\n                source,\r\n                entryPoint: 'mainVertex',\r\n            },\r\n            fragment: {\r\n                source,\r\n                entryPoint: 'mainFragment',\r\n            },\r\n        });\r\n\r\n        const glProgram = GlProgram.from({\r\n            vertex,\r\n            fragment,\r\n            name: 'color-gradient-filter',\r\n        });\r\n\r\n        const maxStops = 32;\r\n\r\n        super({\r\n            gpuProgram,\r\n            glProgram,\r\n            resources: {\r\n                baseUniforms: {\r\n                    uOptions: {\r\n                        value: [\r\n                            // Gradient Type\r\n                            options.type,\r\n                            // Gradient Angle\r\n                            options.angle ?? ANGLE_OFFSET,\r\n                            // Master Alpha\r\n                            options.alpha,\r\n                            // Replace Base Color\r\n                            options.replace ? 1 : 0,\r\n                        ],\r\n                        type: 'vec4<f32>',\r\n                    },\r\n                    uCounts: {\r\n                        value: [\r\n                            // Number of Stops\r\n                            options.stops.length,\r\n                            // Max Gradient Colors\r\n                            options.maxColors,\r\n                        ],\r\n                        type: 'vec2<f32>',\r\n                    },\r\n                },\r\n                stopsUniforms: {\r\n                    uColors: { value: new Float32Array(maxStops * 3), type: 'vec3<f32>', size: maxStops },\r\n\r\n                    // We only need vec2, but we need to pad to eliminate the WGSL warning, TODO: @Mat ?\r\n                    uStops: { value: new Float32Array(maxStops * 4), type: 'vec4<f32>', size: maxStops },\r\n                }\r\n            },\r\n        });\r\n\r\n        this.baseUniforms = this.resources.baseUniforms.uniforms;\r\n        this.stopsUniforms = this.resources.stopsUniforms.uniforms;\r\n\r\n        Object.assign(this, options);\r\n    }\r\n\r\n    get stops(): ColorStop[]\r\n    {\r\n        return this._stops;\r\n    }\r\n\r\n    set stops(stops: ColorStop[])\r\n    {\r\n        const sortedStops = sortColorStops(stops);\r\n        const color = new Color();\r\n        let r;\r\n        let g;\r\n        let b;\r\n\r\n        for (let i = 0; i < sortedStops.length; i++)\r\n        {\r\n            color.setValue(sortedStops[i].color);\r\n            const indexStart = i * 3;\r\n\r\n            [r, g, b] = color.toArray();\r\n            this.stopsUniforms.uColors[indexStart] = r;\r\n            this.stopsUniforms.uColors[indexStart + 1] = g;\r\n            this.stopsUniforms.uColors[indexStart + 2] = b;\r\n\r\n            this.stopsUniforms.uStops[i * 4] = sortedStops[i].offset;\r\n            this.stopsUniforms.uStops[(i * 4) + 1] = sortedStops[i].alpha;\r\n        }\r\n\r\n        this.baseUniforms.uCounts[0] = sortedStops.length;\r\n        this._stops = sortedStops;\r\n    }\r\n\r\n    /**\r\n   * The type of gradient\r\n   * @default ColorGradientFilter.LINEAR\r\n   */\r\n    get type(): number { return this.baseUniforms.uOptions[0]; }\r\n    set type(value: number) { this.baseUniforms.uOptions[0] = value; }\r\n\r\n    /**\r\n   * The angle of the gradient in degrees\r\n   * @default 90\r\n   */\r\n    get angle(): number { return this.baseUniforms.uOptions[1] + ANGLE_OFFSET; }\r\n    set angle(value: number) { this.baseUniforms.uOptions[1] = value - ANGLE_OFFSET; }\r\n\r\n    /**\r\n   * The alpha value of the gradient (0-1)\r\n   * @default 1\r\n   */\r\n    get alpha(): number { return this.baseUniforms.uOptions[2]; }\r\n    set alpha(value: number) { this.baseUniforms.uOptions[2] = value; }\r\n\r\n    /**\r\n   * The maximum number of colors to render (0 = no limit)\r\n   * @default 0\r\n   */\r\n    get maxColors(): number { return this.baseUniforms.uCounts[1]; }\r\n    set maxColors(value: number) { this.baseUniforms.uCounts[1] = value; }\r\n\r\n    /**\r\n     * If true, the gradient will replace the existing color, otherwise it\r\n     * will be multiplied with it\r\n     * @default false\r\n     */\r\n    get replace(): boolean { return this.baseUniforms.uOptions[3] > 0.5; }\r\n    set replace(value: boolean) { this.baseUniforms.uOptions[3] = value ? 1 : 0; }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}