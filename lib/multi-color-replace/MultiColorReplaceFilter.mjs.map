{"version":3,"file":"MultiColorReplaceFilter.mjs","sources":["../../src/multi-color-replace/MultiColorReplaceFilter.ts"],"sourcesContent":["import { Color, ColorSource, deprecation, Filter, GlProgram, GpuProgram } from 'pixi.js';\r\nimport { vertex, wgslVertex } from '../defaults';\r\nimport fragment from './multi-color-replace.frag';\r\nimport source from './multi-color-replace.wgsl';\r\n\r\ntype DeprecatedColor = number | number[] | Float32Array;\r\n\r\n/** Options for the MultiColorReplaceFilter constructor. */\r\nexport interface MultiColorReplaceFilterOptions\r\n{\r\n    /**\r\n     * The collection of replacement items. Each item is color-pair\r\n     * (an array length is 2). In the pair, the first value is original color , the second value is target color\r\n     *\r\n     * _If you wish to change individual elements on the replacement array after instantiation,\r\n     * use the `refresh` function to update the uniforms once you've made the changes_\r\n     */\r\n    replacements: Array<[ColorSource, ColorSource]>;\r\n    /**\r\n     * Tolerance/sensitivity of the floating-point comparison between colors (lower = more exact, higher = more inclusive)\r\n     * @default 0.05\r\n     */\r\n    tolerance?: number\r\n    /**\r\n     * The maximum number of replacements filter is able to use.\r\n     * Because the fragment is only compiled once, this cannot be changed after construction.\r\n     * If omitted, the default value is the length of `replacements`\r\n     */\r\n    maxColors?: number;\r\n}\r\n\r\n/**\r\n * Filter for replacing a color with another color. Similar to ColorReplaceFilter, but support multiple\r\n * colors.<br>\r\n * ![original](../screenshots/original.png)![filter](../screenshots/multi-color-replace.png)\r\n * @class\r\n * @extends Filter\r\n *\r\n * @example\r\n *  // replaces pure red with pure blue, and replaces pure green with pure white\r\n *  someSprite.filters = [new MultiColorReplaceFilter({\r\n *    replacements: [\r\n *      [0xFF0000, 0x0000FF],\r\n *      [0x00FF00, 0xFFFFFF]\r\n *    ],\r\n *    tolerance: 0.001\r\n *  })];\r\n *\r\n *  You also could use [R, G, B] as the color\r\n *  someOtherSprite.filters = [new MultiColorReplaceFilter({\r\n *    replacements: [\r\n *      [ [1,0,0], [0,0,1] ],\r\n *      [ [0,1,0], [1,1,1] ]\r\n *    ],\r\n *    tolerance: 0.001\r\n *  })];\r\n *\r\n */\r\nexport class MultiColorReplaceFilter extends Filter\r\n{\r\n    /** Default values for options. */\r\n    public static readonly DEFAULT_OPTIONS: MultiColorReplaceFilterOptions = {\r\n        replacements: [[0xff0000, 0x0000ff]],\r\n        tolerance: 0.05,\r\n        maxColors: undefined,\r\n    };\r\n\r\n    public uniforms: {\r\n        uOriginalColors: Float32Array;\r\n        uTargetColors: Float32Array;\r\n        uTolerance: number;\r\n    };\r\n\r\n    private _replacements: Array<[ColorSource, ColorSource]> = [];\r\n    private _maxColors: number;\r\n\r\n    /**\r\n     * @param options - Options for the MultiColorReplaceFilter constructor.\r\n     */\r\n    constructor(options?: MultiColorReplaceFilterOptions);\r\n    /**\r\n     * @deprecated since 6.0.0\r\n     *\r\n     * @param {Array<Array>} replacements - The collection of replacement items. Each item is color-pair\r\n     *        (an array length is 2). In the pair, the first value is original color , the second value\r\n     *        is target color.\r\n     * @param {number} [epsilon=0.05] - Tolerance of the floating-point comparison between colors\r\n     *        (lower = more exact, higher = more inclusive)\r\n     * @param {number} [maxColors] - The maximum number of replacements filter is able to use. Because the\r\n     *        fragment is only compiled once, this cannot be changed after construction.\r\n     *        If omitted, the default value is the length of `replacements`.\r\n     */\r\n    constructor(replacements: Array<[DeprecatedColor, DeprecatedColor]>, epsilon?: number, maxColors?: number);\r\n    /** @ignore */\r\n    constructor(...args: [MultiColorReplaceFilterOptions?] | [Array<[DeprecatedColor, DeprecatedColor]>, number?, number?])\r\n    {\r\n        let options = args[0] ?? {} as MultiColorReplaceFilterOptions;\r\n\r\n        if (Array.isArray(options))\r\n        {\r\n            // eslint-disable-next-line max-len\r\n            deprecation('6.0.0', 'MultiColorReplaceFilter constructor params are now options object. See params: { replacements, tolerance, maxColors }');\r\n\r\n            options = { replacements: options };\r\n\r\n            if (args[1]) options.tolerance = args[1];\r\n            if (args[2]) options.maxColors = args[2];\r\n        }\r\n\r\n        options = { ...MultiColorReplaceFilter.DEFAULT_OPTIONS, ...options };\r\n\r\n        const maxColors = options.maxColors ?? options.replacements.length;\r\n\r\n        const gpuProgram = GpuProgram.from({\r\n            vertex: {\r\n                source: wgslVertex,\r\n                entryPoint: 'mainVertex',\r\n            },\r\n            fragment: {\r\n                source: source.replace(/\\$\\{MAX_COLORS\\}/g, (maxColors).toFixed(0)),\r\n                entryPoint: 'mainFragment',\r\n            },\r\n        });\r\n\r\n        const glProgram = GlProgram.from({\r\n            vertex,\r\n            fragment: fragment.replace(/\\$\\{MAX_COLORS\\}/g, (maxColors).toFixed(0)),\r\n            name: 'multi-color-replace-filter',\r\n        });\r\n\r\n        super({\r\n            gpuProgram,\r\n            glProgram,\r\n            resources: {\r\n                multiColorReplaceUniforms: {\r\n                    uOriginalColors: {\r\n                        value: new Float32Array(3 * maxColors),\r\n                        type: 'vec3<f32>',\r\n                        size: maxColors\r\n                    },\r\n                    uTargetColors: {\r\n                        value: new Float32Array(3 * maxColors),\r\n                        type: 'vec3<f32>',\r\n                        size: maxColors\r\n                    },\r\n                    uTolerance: { value: options.tolerance, type: 'f32' },\r\n                }\r\n            },\r\n        });\r\n\r\n        this._maxColors = maxColors;\r\n\r\n        this.uniforms = this.resources.multiColorReplaceUniforms.uniforms;\r\n\r\n        this.replacements = options.replacements;\r\n    }\r\n\r\n    /**\r\n     * The collection of replacement items. Each item is color-pair\r\n     * (an array length is 2). In the pair, the first value is original color , the second value is target color\r\n     */\r\n    set replacements(replacements: Array<[ColorSource, ColorSource]>)\r\n    {\r\n        const originals = this.uniforms.uOriginalColors;\r\n        const targets = this.uniforms.uTargetColors;\r\n        const colorCount = replacements.length;\r\n        const color = new Color();\r\n\r\n        if (colorCount > this._maxColors)\r\n        {\r\n            throw new Error(`Length of replacements (${colorCount}) exceeds the maximum colors length (${this._maxColors})`);\r\n        }\r\n\r\n        // Fill with negative values\r\n        originals[colorCount * 3] = -1;\r\n\r\n        let r;\r\n        let g;\r\n        let b;\r\n\r\n        for (let i = 0; i < colorCount; i++)\r\n        {\r\n            const pair = replacements[i];\r\n\r\n            // for original colors\r\n            color.setValue(pair[0]);\r\n\r\n            [r, g, b] = color.toArray();\r\n\r\n            originals[i * 3] = r;\r\n            originals[(i * 3) + 1] = g;\r\n            originals[(i * 3) + 2] = b;\r\n\r\n            // for target colors\r\n            color.setValue(pair[1]);\r\n\r\n            [r, g, b] = color.toArray();\r\n\r\n            targets[i * 3] = r;\r\n            targets[(i * 3) + 1] = g;\r\n            targets[(i * 3) + 2] = b;\r\n        }\r\n\r\n        this._replacements = replacements;\r\n    }\r\n\r\n    get replacements(): Array<[ColorSource, ColorSource]>\r\n    {\r\n        return this._replacements;\r\n    }\r\n\r\n    /**\r\n      * Should be called after changing any of the contents of the replacements.\r\n      * This is a convenience method for resetting the `replacements`.\r\n      * @todo implement nested proxy to remove the need for this function\r\n      */\r\n    refresh(): void\r\n    {\r\n        this.replacements = this._replacements;\r\n    }\r\n\r\n    /**\r\n      * The maximum number of color replacements supported by this filter. Can be changed\r\n      * _only_ during construction.\r\n      * @readonly\r\n      */\r\n    get maxColors(): number { return this._maxColors; }\r\n\r\n    /**\r\n      * Tolerance of the floating-point comparison between colors (lower = more exact, higher = more inclusive)\r\n      * @default 0.05\r\n      */\r\n    get tolerance(): number { return this.uniforms.uTolerance; }\r\n    set tolerance(value: number) { this.uniforms.uTolerance = value; }\r\n\r\n    /**\r\n     * @deprecated since 6.0.0\r\n     *\r\n     * Tolerance of the floating-point comparison between colors (lower = more exact, higher = more inclusive)\r\n     * @default 0.05\r\n     */\r\n    set epsilon(value: number)\r\n    {\r\n        // eslint-disable-next-line max-len\r\n        deprecation('6.0.0', 'MultiColorReplaceFilter.epsilon is deprecated, please use MultiColorReplaceFilter.tolerance instead');\r\n        this.tolerance = value;\r\n    }\r\n    get epsilon(): number\r\n    {\r\n        // eslint-disable-next-line max-len\r\n        deprecation('6.0.0', 'MultiColorReplaceFilter.epsilon is deprecated, please use MultiColorReplaceFilter.tolerance instead');\r\n\r\n        return this.tolerance;\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}